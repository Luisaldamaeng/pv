<!-- Guarda este archivo como index.html en: C:\xampp\htdocs\PV\lector de codigo QR -->
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lector QR - JavaScript</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 1rem; background:#f7f7f7; }
        #video { width:100%; max-width:600px; border:1px solid #ccc; background:#000; }
        #controls { margin-top:.5rem; }
        #output { margin-top:1rem; padding:.5rem; background:#fff; border:1px solid #ddd; max-width:600px; word-break:break-all; transition: background-color 0.3s; }
        #output.success { background-color: #d4edda; }
        #canvas { display:none; }
        button,input[type=file] { margin-right:.5rem; }
    </style>
</head>
<body>
    <h2>Lector de código QR</h2>

    <video id="video" playsinline></video>

    <div id="controls">
        <button id="startBtn">Iniciar cámara</button>
        <button id="stopBtn" disabled>Detener</button>
        <label>
            o cargar imagen:
            <input type="file" accept="image/*" id="fileInput">
        </label>
    </div>

    <div id="output">Resultado: <span id="result">—</span></div>

    <canvas id="canvas"></canvas>

    <!-- Librería jsQR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resultEl = document.getElementById('result');
        const fileInput = document.getElementById('fileInput');

        let stream = null;
        let scanning = false;
        let rafId = null;
        let audioCtx; // Para el sonido de "bip"

        async function startCamera() {
            // Comprobar si el navegador soporta la API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                resultEl.textContent = 'Error: Tu navegador no soporta el acceso a la cámara.';
                return;
            }

            try {
                // Preferir la cámara trasera (environment). Si falla, intentará con cualquier otra.
                const constraints = { video: { facingMode: 'environment' } };
                resultEl.textContent = 'Solicitando acceso a la cámara...';
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                console.warn("Fallo al solicitar cámara trasera, intentando con cualquier cámara:", err);
                try {
                    // Si falla la cámara trasera, intentar con cualquier cámara disponible
                    const fallbackConstraints = { video: true };
                    stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                } catch (fallbackErr) {
                    // Manejar errores comunes como que el usuario niegue el permiso.
                    console.error("Fallo al solicitar cualquier cámara:", fallbackErr);
                    resultEl.textContent = `Error al acceder a la cámara: ${fallbackErr.name}. Asegúrate de dar permiso y usar localhost o HTTPS.`;
                    return;
                }
            }

            video.srcObject = stream;
            await video.play();
            scanning = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            resultEl.textContent = 'Buscando código QR...';
            tick();
        }

        function stopCamera() {
            scanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            if (rafId) cancelAnimationFrame(rafId);
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }

        function tick() {
            if (!scanning) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code && resultEl.textContent !== code.data) { // Evita lecturas repetidas del mismo código
                    resultEl.textContent = code.data;
                    
                    // Feedback visual y auditivo
                    playBeep();
                    document.getElementById('output').classList.add('success');
                    setTimeout(() => {
                        document.getElementById('output').classList.remove('success');
                    }, 500);

                    // Opcional: detener tras leer. Descomenta la siguiente línea si lo deseas.
                    // stopCamera();

                } else {
                    // mostrar feedback si desea:
                    // resultEl.textContent = 'Buscando...';
                }
            }
            rafId = requestAnimationFrame(tick);
        }

        function scanImageFile(file) {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    resultEl.textContent = code.data;
                    playBeep();
                    document.getElementById('output').classList.add('success');
                    setTimeout(() => document.getElementById('output').classList.remove('success'), 500);
                }
                else {
                    resultEl.textContent = 'No se detectó QR en la imagen.';
                }
                URL.revokeObjectURL(url);
            };
            img.onerror = () => {
                resultEl.textContent = 'No se pudo leer la imagen.';
                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        function playBeep() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn("Web Audio API no es soportada en este navegador.");
                    return;
                }
            }
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // Tono A4
            oscillator.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1); // Duración del bip: 100ms
        }

        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);

        fileInput.addEventListener('change', () => {
            stopCamera();
            const f = fileInput.files[0];
            if (f) scanImageFile(f);
        });

    </script>
</body>
</html>