<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Factura XML</title>
    <!-- Incluimos Bootstrap para un estilo más agradable -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        th {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="mb-3 text-center">Visor de Factura XML</h1>

        <div class="row justify-content-center mb-4">
            <div class="col-md-8 col-lg-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="rutaXmlInput" placeholder="Nombre del archivo XML" value="factura_ekuatia.xml">
                    <button class="btn btn-primary" type="button" id="btnProcesar">Procesar XML</button>
                </div>
            </div>
        </div>
        
        <!-- Aquí se generará la tabla con los datos del XML -->
        <table class="table table-bordered table-striped" id="tablaextrae">
            <thead>
                <tr>
                    <th>Código Interno (cod_inter)</th>
                    <th>Nombre</th>
                    <th>Cantidad (Cant)</th>
                    <th>Precio Unitario</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas de datos se insertarán aquí con JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
    // Función para procesar el archivo XML y llenar la tabla
    async function procesarFacturaXML(rutaXML) {
        const tablaBody = document.querySelector("#tablaextrae tbody");
        // Limpiar la tabla antes de cargar nuevos datos
        tablaBody.innerHTML = '<tr><td colspan="4" class="text-center">Cargando...</td></tr>';

        try {
            if (!rutaXML) throw new Error("El nombre del archivo no puede estar vacío.");

            // 1. Cargar el archivo XML usando fetch
            const response = await fetch(rutaXML);
            if (!response.ok) {
                throw new Error(`Error al cargar el XML: ${response.statusText}`);
            }
            const xmlText = await response.text();

            // 2. Parsear el texto XML
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "application/xml");

            // Manejo de errores de parseo
            const errorNode = xmlDoc.querySelector("parsererror");
            if (errorNode) {
                throw new Error("Error al parsear el XML: " + errorNode.innerText);
            }

            // Limpiar el mensaje de "Cargando..."
            tablaBody.innerHTML = '';

            // 3. Recorrer cada ítem de la factura. El tag es 'gCamItem'.
            // Usamos 'getElementsByTagName' que funciona mejor con namespaces.
            const items = xmlDoc.getElementsByTagName('gCamItem');

            for (const item of items) {
                // 4. Extraer los valores de las etiquetas para cada ítem
                const cod_inter = item.getElementsByTagName('dCodInt')[0]?.textContent || 'N/A';
                const nombre = item.getElementsByTagName('dDesProSer')[0]?.textContent || 'N/A';
                const cantidad = item.getElementsByTagName('dCantProSer')[0]?.textContent || '0';
                const precio = item.getElementsByTagName('dPUniProSer')[0]?.textContent || '0';

                // 5. Crear una nueva fila (<tr>) y celdas (<td>) para la tabla
                const nuevaFila = tablaBody.insertRow();
                
                nuevaFila.insertCell(0).textContent = cod_inter;
                nuevaFila.insertCell(1).textContent = nombre;
                nuevaFila.insertCell(2).textContent = cantidad;
                nuevaFila.insertCell(3).textContent = parseFloat(precio).toLocaleString('es-PY'); // Formato de número
            }

            if (items.length === 0) {
                tablaBody.innerHTML = `<tr><td colspan="4" class="text-center text-warning">No se encontraron ítems en el archivo '${rutaXML}'.</td></tr>`;
            }

        } catch (error) {
            console.error("Ocurrió un error:", error);
            tablaBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error al procesar el archivo: ${error.message}</td></tr>`;
        }
    }

    // Añadir listeners cuando el DOM esté cargado
    document.addEventListener('DOMContentLoaded', function() {
        const btnProcesar = document.getElementById('btnProcesar');
        const inputRuta = document.getElementById('rutaXmlInput');

        // Procesar al hacer clic en el botón
        btnProcesar.addEventListener('click', () => {
            procesarFacturaXML(inputRuta.value.trim());
        });

        // Procesar también al presionar "Enter" en el campo de texto
        inputRuta.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                procesarFacturaXML(inputRuta.value.trim());
            }
        });
    });
    </script>

</body>
</html>